<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>TD + p5 pointillism demo</title>

    <!-- p5 from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.min.js"></script>
</head>

<body>
    <label for="slider">slider:</label><input id="slider" type="range" min="0" max="1" step="0.01" value="0.5"></label>

    <label for="number">number:</label><input id="number" type="number" step="0.1" value="1"></label>

    <label for="msg">Message:</label>
    <input id="msg" type="text" size="30">
    <button id="sendBtn">Send</button>

    <hr>
    <div id="p5-holder"></div> <!-- canvas will land here -->

    <p><strong>Last update from server:</strong> <span id="status">none</span></p>

    <label for="txCanvas">send canvas:</label>
    <input id="txCanvas" type="checkbox" title="Enable sending canvas"> enable

    <script>
        /* ------------------------------------------------------------------ */
        /* 0.  WebSocket setup                                                */
        /* ------------------------------------------------------------------ */
        const ws = new WebSocket(`ws://${location.hostname}:5001`);
        function post(o) { if (ws.readyState === 1) ws.send(JSON.stringify(o)); }

        /* UI → TD (same as before) */
        slider.oninput = e => post({ type: 'slider', value: +e.target.value });
        number.onchange = e => post({ type: 'number', value: +e.target.value });
        sendBtn.onclick = () => post({ type: 'text', value: msg.value });

        /* ------------------------------------------------------------------ */
        /* 1.  p5                                                      */
        /* ------------------------------------------------------------------ */

        let sketch = p => {
            let imgref = null, cellSize = 2;
            const repaintPerFrame = 500;
            let frameCountTx = 0;
            let frameThrottleSkip = 2; // send every nth frame
            let showInput = false;

            p.setup = () => { p.createCanvas(480, 480).parent('p5-holder'); p.background(230); };

            p.keyPressed = () => {
                if (p.keyCode === 'p') { // space
                    p.background(230);
                    p.image(imgref, 0, 0, 0.25 * p.width, 0.25 * p.height);
                }
            };
            p.draw = () => {
                if (!imgref) return;
                // p.image(imgref, 0, 0, 1 * p.width, 1 * p.height); //ref image
                for (let i = 0; i < repaintPerFrame; i++) {
                    const x = p.random(imgref.width), y = p.random(imgref.height);
                    let c = imgref.get(x, y);
                    const sx = p.map(x, 0, imgref.width, 0, p.width), sy = p.map(y, 0, imgref.height, 0, p.height);
                    c = p.color(p.red(c) + p.random(-20, 20), p.green(c) + p.random(-20, 20), p.blue(c), 255);

                    p.noStroke(); p.fill(c); p.ellipse(sx, sy, p.random(cellSize), cellSize);
                    // p.stroke(c); p.noFill(); p.ellipse(sx, sy, cellSize, cellSize);
                }
                if(showInput){p.image(imgref, 0, 0, 0.25 * p.width, 0.25 * p.height);}
                // sendCanvasIfEnabled(); 
                if(++frameCountTx % frameThrottleSkip === 0) sendCanvasIfEnabled();  // ≈10 fps at 60 Hz
            };

            p.handleIncoming = (b64, mime) => {
                p.loadImage(`data:${mime};base64,${b64}`, img => {
                    imgref = img; cellSize = 0.01 * img.width;
                });
            };
        };

        function sendCanvasIfEnabled() {
            if (!txCanvas.checked) return;
            const mime = 'image/jpeg';
            const b64 = p5Instance.canvas.toDataURL(mime, 0.85).split(',')[1]; // strip prefix
            post({ type: 'image', mime, data: b64 });
        }

        const p5Instance = new p5(sketch, 'p5-holder');   // << store reference

        /// websocket
        ws.onmessage = ({ data }) => {
            const m = JSON.parse(data);
            status.textContent = data;

            if (m.type === 'slider') slider.value = m.value;
            if (m.type === 'number') number.value = m.value;
            if (m.type === 'text') msg.value = m.value;

            if (m.type === 'image') {
                p5Instance.handleIncoming(m.data, m.mime);    // << safe call
            }
        };

    </script>
</body>
</html>